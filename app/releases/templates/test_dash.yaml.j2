#
#apiVersion: v1
#kind: ConfigMap
#metadata:
#  name: seldon-dashboard-{{ model_name }}
#  namespace: monitoring
#  labels:
#    grafana_dashboard: "1"  # Sidecar will detect this
#data:
#  {{ model_name }}-dashboard.json: |
#    {{ lookup_json | replace('"uid": "seldon-deployment"', '"uid": "' + model_name + '"')
#                   | replace('seldon-deployment', model_name)
#                   | tojson }}
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: seldon-dashboard-{{ model_name }}
  namespace: monitoring
  labels:
    grafana_dashboard: "1"  # Sidecar will detect this
data:
# http://prometheus.monitoring.svc.cluster.local:9090/prometheus
  {{ model_name }}-dashboard.json: |
    {
        "uid": "{{ model_name }}",
        "title": "{{ model_name }} Metrics",
        "description": "This dashboard tracks key metrics for Seldon Core, including inference requests, system resource usage, and performance.",
        "editable": true,
        "annotations": {
            "list": [
                {
                    "builtIn": 1,
                    "type": "dashboard"
                }
            ]
        },
        "panels": [
            {
                "title": "System Metrics",
                "type": "row"
            },
            {
                "title": "CPU Usage (%)",
                "type": "gauge",
                "datasource": "Prometheus",
                "gridPos": { "x": 0, "y": 0, "w": 6, "h": 4 },
                "targets": [{ "expr": "server_cpu_usage", "legendFormat": "CPU %" }],
                "fieldConfig": {
                    "defaults": {
                        "min": 0,
                        "max": 100,
                        "unit": "percent",
                        "custom": {
                            "thresholds": {
                                "mode": "percentage",
                                "steps": [
                                    { "color": "green", "value": 0 },
                                    { "color": "yellow", "value": 50 },
                                    { "color": "red", "value": 80 }
                                ]
                            }
                        }
                    }
                }
            },
            {
                "title": "Memory Usage (%)",
                "type": "gauge",
                "datasource": "Prometheus",
                "gridPos": { "x": 6, "y": 0, "w": 6, "h": 4 },
                "targets": [{ "expr": "(server_memory_usage_gigabytes / server_total_memory_gigabytes) * 100", "legendFormat": "Memory %" }],
                "fieldConfig": {
                    "defaults": {
                        "min": 0,
                        "max": 100,
                        "unit": "percent",
                        "custom": {
                            "thresholds": {
                                "mode": "percentage",
                                "steps": [
                                    { "color": "green", "value": 0 },
                                    { "color": "yellow", "value": 50 },
                                    { "color": "red", "value": 80 }
                                ]
                            }
                        }
                    }
                }
            },
            {
                "title": "GPU Utilization (%)",
                "type": "gauge",
                "datasource": "Prometheus",
                "gridPos": { "x": 0, "y": 4, "w": 6, "h": 4 },
                "targets": [{ "expr": "server_gpu_1_utilization", "legendFormat": "GPU %" }],
                "fieldConfig": {
                    "defaults": {
                        "min": 0,
                        "max": 100,
                        "unit": "percent",
                        "custom": {
                            "thresholds": {
                                "mode": "percentage",
                                "steps": [
                                    { "color": "green", "value": 0 },
                                    { "color": "yellow", "value": 50 },
                                    { "color": "red", "value": 80 }
                                ]
                            }
                        }
                    }
                }
            },
            {
                "title": "GPU Memory Usage (%)",
                "type": "gauge",
                "datasource": "Prometheus",
                "gridPos": { "x": 6, "y": 4, "w": 6, "h": 4 },
                "targets": [{ "expr": "(server_gpu_1_memory_usage_gigabytes / server_gpu_1_total_memory_gigabytes) * 100", "legendFormat": "GPU Mem %" }],
                "fieldConfig": {
                    "defaults": {
                        "min": 0,
                        "max": 100,
                        "unit": "percent",
                        "custom": {
                            "thresholds": {
                                "mode": "percentage",
                                "steps": [
                                    { "color": "green", "value": 0 },
                                    { "color": "yellow", "value": 50 },
                                    { "color": "red", "value": 80 }
                                ]
                            }
                        }
                    }
                }
            },
            {
                "title": "Inference Metrics",
                "type": "row"
            },
            {
                "title": "Total Inference Requests",
                "type": "stat",
                "datasource": "Prometheus",
                "gridPos": { "x": 0, "y": 8, "w": 4, "h": 3 },
                "targets": [{ "expr": "server_requests_total", "legendFormat": "Total Requests" }]
            },
            {
                "title": "Successful Predictions",
                "type": "stat",
                "datasource": "Prometheus",
                "gridPos": { "x": 4, "y": 8, "w": 4, "h": 3 },
                "targets": [{ "expr": "server_successful_predictions_total", "legendFormat": "Success" }]
            },
            {
                "title": "Failed Predictions",
                "type": "stat",
                "datasource": "Prometheus",
                "gridPos": { "x": 8, "y": 8, "w": 4, "h": 3 },
                "targets": [{ "expr": "server_failed_predictions_total", "legendFormat": "Failures" }]
            },
            {
                "title": "Performance Metrics",
                "type": "row"
            },
            {
                "title": "Inference Latency (95th Percentile)",
                "type": "timeseries",
                "datasource": "Prometheus",
                "gridPos": { "x": 0, "y": 11, "w": 12, "h": 6 },
                "targets": [
                    {
                        "expr": "histogram_quantile(0.95, sum(rate(server_inference_duration_seconds_bucket[30s])) by (le))",
                        "legendFormat": "95th Percentile"
                    }
                ],
                "fieldConfig": {
                    "defaults": {
                        "custom": {
                            "drawStyle": "line",
                            "lineWidth": 2,
                            "fillOpacity": 0,
                            "showPoints": "never"
                        }
                    }
                }
            },
            {
                "title": "CPU Time Spent (s)",
                "type": "timeseries",
                "datasource": "Prometheus",
                "gridPos": { "x": 0, "y": 17, "w": 12, "h": 6 },
                "targets": [{ "expr": "process_cpu_seconds_total", "legendFormat": "CPU Time" }]
            }
        ]
    }



#     {
#       "uid": "4fd366b0",
#       "title": "4fd366b0",
#       "editable": true,
#       "annotations": {
#         "list": [
#           {
#             "builtIn": 1,
#             "type": "dashboard"
#           }
#         ]
#       },
#       "panels": [
#         {
#           "title": "Total Inference Requests",
#           "type": "stat",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "server_requests_total", "legendFormat": "Total Requests" }]
#         },
#         {
#           "title": "Successful Predictions",
#           "type": "stat",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "server_successful_predictions_total", "legendFormat": "Success" }]
#         },
#         {
#           "title": "Failed Predictions",
#           "type": "stat",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "server_failed_predictions_total", "legendFormat": "Failures" }]
#         },
#         {
#           "title": "CPU Usage (%)",
#           "type": "gauge",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "server_cpu_usage", "legendFormat": "CPU %" }]
#         },
#         {
#           "title": "Memory Usage (GB)",
#           "type": "gauge",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "server_memory_usage_gigabytes", "legendFormat": "Memory GB" }]
#         },
#         {
#           "title": "GPU Utilization (%)",
#           "type": "gauge",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "server_gpu_1_utilization", "legendFormat": "GPU %" }]
#         },
#         {
#           "title": "GPU Memory Usage (GB)",
#           "type": "gauge",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "server_gpu_1_memory_usage_gigabytes", "legendFormat": "GPU Mem GB" }]
#         },
#         {
#           "title": "Inference Latency",
#           "type": "graph",
#           "datasource": "Prometheus",
#           "targets": [
#             { 
#               "expr": "histogram_quantile(0.95, sum(rate(server_inference_duration_seconds_bucket[5m])) by (le))",
#               "legendFormat": "95th Percentile"
#             }
#           ]
#         },
#         {
#           "title": "Virtual Memory Usage",
#           "type": "stat",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "process_virtual_memory_bytes / 1e9", "legendFormat": "Virtual Mem (GB)" }]
#         },
#         {
#           "title": "Resident Memory Usage",
#           "type": "stat",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "process_resident_memory_bytes / 1e9", "legendFormat": "Resident Mem (GB)" }]
#         },
#         {
#           "title": "Model Load Time (s)",
#           "type": "stat",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "model_load_time_seconds", "legendFormat": "Load Time" }]
#         },
#         {
#           "title": "Server Load Time (s)",
#           "type": "stat",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "server_load_time_seconds", "legendFormat": "Server Load" }]
#         },
#         {
#           "title": "Process Start Time",
#           "type": "stat",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "process_start_time_seconds", "legendFormat": "Start Time (s)" }]
#         },
#         {
#           "title": "CPU Time Spent (s)",
#           "type": "graph",
#           "datasource": "Prometheus",
#           "targets": [{ "expr": "process_cpu_seconds_total", "legendFormat": "CPU Time" }]
#         }
#       ]
#     }
